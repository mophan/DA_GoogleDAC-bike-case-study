---
title: "Bike Share Case Study"
output: html_document
---


```{r setup, include=FALSE}

# packages
library(tidyverse)
library(lubridate)
library(gt)
library(glue)
library(data.table)  # read csv faster
library(ggplot2)


# folder
folder_output <- "4_output"

```


```{r import data, echo=FALSE, message=FALSE, results='hide'}

# import trips since 2020
trips20_data <-
  fread(file.path(folder_output, 'trips20_data.csv')) %>%
  mutate_if(is.numeric, as.numeric)


# view data
glimpse(trips20_data)


# check data
table(is.na(trips20_data$ride_id))
table(trips20_data$ride_id == "")

addmargins(table(trips20_data$rideable_type))

min(trips20_data$start_date)
max(trips20_data$end_date)

table(is.na(trips20_data$ride_length))
table(trips20_data$ride_length == "")

table(trips20_data$start_station_name == "")
table(is.na(trips20_data$start_station_name))

table(is.na(trips20_data$start_station_id))
table(is.na(trips20_data$start_lat))
table(is.na(trips20_data$start_lng))
table(is.na(trips20_data$end_lat))
table(is.na(trips20_data$end_lng))

addmargins(table(trips20_data$member_casual))


# select the last 1 year
date_end <- max(trips20_data$end_date)
date_start <- format(ymd(date_end) - years(1), '%Y%m%d') %>% as.numeric()


# filter one year
trip_data <-
  trips20_data %>%
  filter(start_date >= date_start)


# get mindate, maxdate
min_date <- min(trip_data$start_date)
max_date <- max(trip_data$end_date)

```


```{r data cleansing, echo=FALSE}

# rename columns
trip_data <-
  trip_data %>%
  rename(
    trip_id = ride_id,
    start_time = started_at,
    end_time = ended_at,
    usertype = member_casual
  )


# calculate ride length in second
trip_data <-
  trip_data %>%
  mutate(across(c(start_time, end_time), as_datetime),
         trip_length_insecond = as.numeric(difftime(end_time, start_time)),
         .after = 'end_time')


# filter out trips for quality check
# PS: HQ QR = headquater QR
trip_data <- 
  trip_data %>% 
  filter(!(start_station_name == 'HQ QR' | trip_length_insecond < 0))


# add year, month, monthid, day of week
trip_data <- 
  trip_data %>% 
  mutate(
    year = year(start_time),
    month = month(start_time),
    monthid = as.numeric(format(start_time, '%Y%m')),
    dow = str_sub(weekdays(start_time), 1, 3),
    .before = 'start_date'
  )


```


Data: from `r ymd(min_date)` to `r ymd(max_date)`

This analysis is to study how different annual members and casual riders used Cyclistic bikes.



### 1.  Trip length

Table below shows descriptive stat of trip length (in seconds) of all trips

```{r trip length stat, echo=FALSE}

# calculate ride length stat
overall_stat <- 
  trip_data %>% 
  group_by() %>% 
  summarise(
        TripCount = n_distinct(trip_id),
        Min_Length = min(trip_length_insecond, na.rm = TRUE),
        Q1_Length = quantile(trip_length_insecond, 0.25, type = 1, na.rm = FALSE),
        Median_Length = median(trip_length_insecond, na.rm = TRUE),
        Mean_Length = mean(trip_length_insecond),
        Q3_Length = quantile(trip_length_insecond, 0.75, type = 1,  na.rm = FALSE),
        Max_Length = max(trip_length_insecond, na.rm = TRUE)
      ) %>%
  mutate(
    DataType = 'overall', .before = 'TripCount')


# calculate ride length stat by user type
ridelength_stat <- 
  overall_stat %>% 
  bind_rows(
      trip_data %>% 
      group_by(usertype) %>% 
      summarise(
        TripCount = n_distinct(trip_id),
        Min_Length = min(trip_length_insecond, na.rm = TRUE),
        Q1_Length = quantile(trip_length_insecond, 0.25, type = 1, na.rm = FALSE),
        Median_Length = median(trip_length_insecond, na.rm = TRUE),
        Mean_Length = mean(trip_length_insecond),
        Q3_Length = quantile(trip_length_insecond, 0.75, type = 1,  na.rm = FALSE),
        Max_Length = max(trip_length_insecond, na.rm = TRUE)
      ) %>% 
      rename(DataType = usertype)
  )


# calculate trip count percentage
ridelength_stat <-
  ridelength_stat %>%
  mutate(
    TripCountPercent = round(TripCount / ridelength_stat$TripCount[DataType == "overall"] * 100, digits = 1),
    .after = 'TripCount'
  )


# stat of all trips
ridelength_stat %>% 
  gt()

```



### 2. Trip length by user type {.tabset}

```{r detect outliers, echo=FALSE}

# cut off points to detect outliers
IQR <- overall_stat$Q3_Length - overall_stat$Q1_Length

upper_bound <- overall_stat$Q3_Length + 1.5 * IQR

lower_bound <-
  if(overall_stat$Q1_Length < 1.5 * IQR) 0 else {
    overall_stat$Q1_Length - 1.5 * IQR
  }


# remove outliers
filtered_trip_data <-
  trip_data %>%
  filter(trip_length_insecond <= upper_bound)


```

To better visualize the boxplot, the outliers outside 1.5 interquartile range (IQR) from Q1 and Q3 are excluded.
This means trips longer than `r upper_bound` seconds (approximately `r upper_bound %/% 60` minutes) and less than `r lower_bound` seconds are excluded.

#### By User Type

```{r boxplot usertype, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

# function to calculate median 
fun_med <- function(x) return(data.frame(y=median(x),label=median(x,na.rm=T)))
fun_mean <- function(x) return(data.frame(y=mean(x), label=round(mean(x, na.rm=T), 0)))


# box plot of trip length by user type
filtered_trip_data %>% 
  ggplot(aes(usertype, trip_length_insecond, fill = usertype)) +
  geom_boxplot() +
  labs(x = "", y = "trip length (in seconds)") +
  stat_summary(fun.data = fun_med, geom = "text", vjust = 1.3) +
  stat_summary(fun.y = mean, geom = "point", colour = "black",
               shape = 18, size = 2) +
  stat_summary(fun.data = fun_mean, geom = "text", vjust = -0.7)



```

#### By Month

```{r boxplot by year, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}

# box plot of trip length by month
filtered_trip_data %>% 
  ggplot(aes(as.character(monthid), trip_length_insecond)) +
  geom_boxplot() +
  labs(x = "month", y = "trip length (in seconds)")

```


#### By Month and User Type


### 3.  Trip length by day of week

### 4.  Number of rides

### 5.  Demographic of subscribers

### 6.  Location
